# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code, run tests and deploy to GitHub Pages
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI and Deploy to Pages

on:
  push:
    branches: [ "pages" ]
  pull_request:
    branches: [ "pages" ]
  workflow_dispatch:

# è®¾ç½®GITHUB_TOKENçš„æƒé™ï¼Œä»¥å…è®¸éƒ¨ç½²åˆ°GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# å…è®¸åªæœ‰ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡åœ¨æ­£åœ¨è¿›è¡Œçš„è¿è¡Œå’Œæœ€æ–°æ’é˜Ÿçš„è¿è¡Œä¹‹é—´æ’é˜Ÿçš„è¿è¡Œã€‚
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.20.2] # å»ºè®®æ ¹æ®é¡¹ç›®å®é™…æ”¯æŒçš„Node.jsç‰ˆæœ¬è°ƒæ•´
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§° Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'yarn' # ä½¿ç”¨npmç¼“å­˜ï¼Œå¦‚æœä½ ç”¨yarnï¼Œå¯è€ƒè™‘æ”¹ä¸º' yarn 'æˆ–æ ¹æ®éœ€è¦è®¾ç½®

    - name: ğŸ“¦ Install dependencies (yarn)
      run: |
        yarn install --frozen-lockfile # ä½¿ç”¨ --frozen-lockfile å¯ä»¥ç¡®ä¿lockfileä¸€è‡´
        npx update-browserslist-db@latest

    - name: ğŸ› ï¸ Build project
      run: |
        yarn build
        # åœ¨æ„å»ºååˆ›å»º .nojekyll æ–‡ä»¶
        touch docs/.nojekyll
        
    # - name: ğŸ” Check for changes to yarn.lock
    #   id: check_changes
    #   run: |
    #     # æ£€æŸ¥yarn.lockæ˜¯å¦æœ‰æ›´æ”¹
    #     if git diff --exit-code --quiet yarn.lock; then
    #       echo "lockfile_changed=false" >> $GITHUB_OUTPUT
    #       echo "âœ… yarn.lock æ²¡æœ‰å˜åŒ–ï¼Œæ— éœ€æ¨é€ã€‚"
    #     else
    #       echo "lockfile_changed=true" >> $GITHUB_OUTPUT
    #       echo "ğŸ“ yarn.lock å·²æ›´æ–°ï¼Œå‡†å¤‡æäº¤å’Œæ¨é€ã€‚"
    #       git diff yarn.lock # å¯é€‰ï¼šæ˜¾ç¤ºå˜æ›´å†…å®¹
    #     fi

    # - name: ğŸ’¾ Commit and push updated yarn.lock
    #   if: steps.check_changes.outputs.lockfile_changed == 'true'
    #   run: |
    #     # é…ç½®Gitç”¨æˆ·ï¼ˆä½¿ç”¨GitHub Actions botä¿¡æ¯ï¼‰
    #     git config --global user.name "github-actions[bot]"
    #     git config --global user.email "github-actions[bot]@users.noreply.github.com"

    #     # æš‚å­˜å‘ç”Ÿå˜åŒ–çš„yarn.lockæ–‡ä»¶
    #     git add yarn.lock

    #     # æäº¤æ›´æ”¹
    #     git commit -m "chore: update yarn.lock file [skip ci]"

    #     # æ¨é€åˆ°å½“å‰åˆ†æ”¯
    #     # ä½¿ç”¨ `--no-verify` è·³è¿‡å¯èƒ½å­˜åœ¨çš„pre-pushé’©å­ï¼ˆå¯é€‰ï¼‰
    #     git push origin HEAD:${{ github.ref_name }} --no-verify
    #     echo "âœ… å·²æ›´æ–° yarn.lock å¹¶æ¨é€åˆ°åˆ†æ”¯ ${{ github.ref_name }}"

    - name: ğŸ“‚ Upload production-ready build artifacts
      uses: actions/upload-pages-artifact@v3 # ä¸Šä¼ æ„å»ºäº§ç‰©ï¼Œä¸ºéƒ¨ç½²åšå‡†å¤‡
      with:
        path: ./docs # å…³é”®ï¼šè¿™é‡Œéœ€è¦æ›¿æ¢ä¸ºä½ çš„é¡¹ç›®æ„å»ºè¾“å‡ºç›®å½•ï¼Œä¾‹å¦‚ 'dist', 'build', 'out', 'public' ç­‰

  # éƒ¨ç½²ä½œä¸šï¼Œä¾èµ–äºæ„å»ºä½œä¸šçš„å®Œæˆ
  deploy:
    environment: # å®šä¹‰éƒ¨ç½²ç¯å¢ƒï¼Œå¯åœ¨Gitä»“åº“çš„Environmentsä¸­æŸ¥çœ‹éƒ¨ç½²å†å²
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # éƒ¨ç½²åè¾“å‡ºçš„URL

    runs-on: ubuntu-latest
    needs: build # ç¡®ä¿åœ¨buildä½œä¸šå®Œæˆåè¿è¡Œ

    steps:
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4 # è¿™æ˜¯å®˜æ–¹æ¨èçš„éƒ¨ç½²Pagesçš„Action
